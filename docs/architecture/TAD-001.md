# TAD-001: Universal Adaptive Testing Platform

**Version:** 1.0.0
**Status:** Draft
**Phase:** Phase 1 - B2C Platform
**PRD Reference:** PRD-001
**Created:** 2026-01-02
**Updated:** 2026-01-03

---

## Table of Contents

1. [System Overview](#system-overview)
2. [Architectural Principles](#architectural-principles)
3. [System Components](#system-components)
4. [Data Architecture](#data-architecture)
5. [Integration Architecture](#integration-architecture)
6. [Security Architecture](#security-architecture)
7. [Deployment Architecture](#deployment-architecture)
8. [Operational Concerns](#operational-concerns)
9. [Architectural Decisions](#architectural-decisions)
10. [Traceability Matrix](#traceability-matrix)

---

## System Overview

A cloud-native adaptive testing platform built as a TypeScript pnpm monorepo with microservices architecture. Phase 1 focuses on B2C delivery enabling individual students to discover, purchase, and take adaptive exams via web and mobile applications.

### Key Characteristics

| Characteristic | Description |
|----------------|-------------|
| Architecture Style | Microservices with shared packages |
| Primary Language | TypeScript (Node.js + React) |
| Secondary Language | Python (Scoring Service) |
| Databases | PostgreSQL 16 + MongoDB + Redis 7 |
| Deployment | Kubernetes on AWS EKS |
| CI/CD | GitHub Actions |

### Core Capabilities

- Pluggable strategy architecture for multiple exam methodologies
- Real-time adaptive scoring with sub-200ms latency
- Cross-device progress synchronization
- Pay-per-exam model with unlimited attempts until pass
- Persistent analytics and exam recommendations
- Native mobile apps with offline support

### High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Client Applications                          │
├─────────────────┬─────────────────┬─────────────────────────────────┤
│   spa-student   │    spa-admin    │         mobile-app              │
│   (Next.js)     │    (Next.js)    │      (React Native)             │
└────────┬────────┴────────┬────────┴────────────┬────────────────────┘
         │                 │                      │
         └────────────────┬┴──────────────────────┘
                          │
                 ┌────────▼────────┐
                 │   API Gateway    │
                 │ api.uatplatform  │
                 └────────┬────────┘
                          │
         ┌────────────────┼────────────────┐
         │                │                │
┌────────▼────────┐ ┌────▼─────────┐ ┌────▼─────────┐
│   api-service   │ │   scoring-   │ │   External   │
│   (Express)     │ │   service    │ │   Services   │
│                 │ │   (FastAPI)  │ │   (Stripe,   │
│                 │ │              │ │   Auth0,     │
│                 │ │              │ │   LiteLLM)   │
└────────┬────────┘ └──────────────┘ └──────────────┘
         │
    ┌────┴────┬──────────┐
    │         │          │
┌───▼───┐ ┌───▼───┐ ┌────▼────┐
│Postgres│ │ Redis │ │ MongoDB │
│   16   │ │   7   │ │(Settings)│
└────────┘ └───────┘ └─────────┘
```

---

## Architectural Principles

### 1. Configuration Over Code

Exam rules, scoring algorithms, and stopping criteria are metadata-driven, not hard-coded. This enables rapid deployment of new exam types without code changes.

```json
{
  "examProfile": {
    "methodology": "CAT",
    "scoringModel": "3PL",
    "stoppingCriteria": {
      "type": "SEM",
      "threshold": 0.3,
      "minItems": 20,
      "maxItems": 60
    }
  }
}
```

### 2. Strategy Pattern for Extensibility

New exam types can be added by implementing strategy interfaces without modifying core engine code.

### 3. Service Decoupling

Scoring, content, and session services communicate via versioned APIs only. No direct database access between services.

### 4. Mobile-First Design

All features work seamlessly across web and mobile with real-time sync.

### 5. Progressive Enhancement

Offline-capable with graceful degradation when connectivity is limited.

---

## System Components

### Applications

#### api-service (Backend)

| Property | Value |
|----------|-------|
| Technology | Node.js / Express / TypeScript |
| Port | 3000 |
| Responsibilities | Exam session management, Question delivery, User auth, Payment webhooks, Progress sync |

#### scoring-service (Backend)

| Property | Value |
|----------|-------|
| Technology | Python / FastAPI |
| Port | 3001 |
| Responsibilities | Theta estimation (1PL, 2PL, 3PL), Next item selection, Exposure control, Stopping rule evaluation |

#### spa-student (Frontend)

| Property | Value |
|----------|-------|
| Technology | Next.js 15 / React / TypeScript |
| Responsibilities | Exam catalog browsing, Exam taking interface, Progress dashboard with performance trends, Post-exam analytics and gap analysis, Study time recommendations, Topic-based practice exams, Exam scheduling suggestions, Pay-per-exam purchase management, Exam recommendations display |

#### spa-admin (Frontend)

| Property | Value |
|----------|-------|
| Technology | Next.js 15 / React / TypeScript |
| Responsibilities | Question bank management, Exam profile configuration, User management, Analytics and reporting, Content workflow, App settings configuration |

#### mobile-app (Mobile)

| Property | Value |
|----------|-------|
| Technology | React Native / TypeScript |
| Responsibilities | Exam taking on mobile, Offline exam caching, Push notifications, Progress sync, Dashboard access |

### Shared Packages

| Package | Description | Exports |
|---------|-------------|---------|
| `@uat/backend-common` | Shared backend utilities, middleware, and services | logger, exceptions, middleware, database clients |
| `@uat/backend-scoring` | IRT scoring algorithms and theta estimation | RaschStrategy, ThreePLStrategy, ThetaEstimator, ItemSelector |
| `@uat/backend-payments` | Stripe integration for subscriptions and purchases | StripeClient, SubscriptionManager, PurchaseHandler |
| `@uat/shared-types` | Shared TypeScript type definitions | ExamTypes, UserTypes, SessionTypes, PaymentTypes |
| `@uat/ui-components` | Shared React component library for Next.js apps | Button, Card, DataTable, Chart, ExamCard, ProgressBar |

---

## Data Architecture

### PostgreSQL 16 (Primary Database)

**Purpose:** Transactional data with ACID compliance

**Tables:**
| Table | Purpose |
|-------|---------|
| `users` | User accounts and profiles |
| `exam_profiles` | Exam configuration metadata |
| `question_banks` | Question bank definitions |
| `questions` | Question content (JSONB) |
| `question_tags` | Hierarchical tagging system |
| `sessions` | Active exam sessions |
| `responses` | User responses per session |
| `exam_purchases` | Pay-per-exam purchase records |
| `exam_attempts` | Individual attempt tracking |
| `user_progress` | Aggregate progress data |
| `user_analytics` | Analytics snapshots |
| `study_recommendations` | Generated study plans |
| `exam_recommendations` | Suggested next exams |
| `audit_logs` | Immutable audit trail |

**Features:**
- JSONB for flexible question content
- Row-Level Security ready for Phase 2

### MongoDB (Settings Database)

**Purpose:** Application settings and configuration (admin-configurable without deployment)

**Collections:**
| Collection | Purpose |
|------------|---------|
| `app_settings` | Global application settings |
| `feature_flags` | Feature toggles |
| `llm_provider_config` | LiteLLM provider settings |
| `exam_defaults` | Default exam configurations |
| `ui_customizations` | UI theme and branding |
| `rate_limits` | Rate limiting configurations |

### Redis 7 (Cache)

**Purpose:** Session state, pre-fetched questions, rate limiting

**Patterns:**
- Session storage (active exam state)
- Question cache (pre-fetched items)
- Rate limit counters

### Redis Streams (Message Queue)

**Purpose:** Async event processing

**Events:**
- `ExamCompleted` - Triggers analytics generation
- `PaymentProcessed` - Updates access permissions
- `ProgressUpdated` - Syncs across devices

---

## Integration Architecture

### External Services

| Service | Purpose | Integration | Features |
|---------|---------|-------------|----------|
| **LiteLLM** | Unified LLM API gateway | REST API (OpenAI-compatible) | Multi-provider support (OpenAI, Anthropic), Content generation, Question validation, Analytics insights |
| **Stripe** | Payment processing | REST API + Webhooks | Pay-per-exam purchases, Subscriptions, Invoicing |
| **Auth0** | Authentication | OAuth 2.0 / OIDC | Social login, MFA, JWT tokens |
| **SendGrid** | Transactional email | REST API | Purchase confirmations, Study reminders, Notifications |
| **Firebase** | Mobile push notifications | Firebase SDK | Push notifications, Analytics |

### Internal APIs

| Endpoint | Methods | Description |
|----------|---------|-------------|
| `/api/v1/exams` | GET, POST | Exam catalog and profile management |
| `/api/v1/sessions` | GET, POST, PATCH | Exam session lifecycle |
| `/api/v1/questions` | GET, POST, PUT, DELETE | Question bank CRUD operations |
| `/api/v1/users/progress` | GET, POST | User progress and analytics |
| `/api/v1/purchases` | GET, POST | Pay-per-exam purchases and access management |
| `/api/v1/subscriptions` | GET, POST, DELETE | Subscription management |
| `/api/v1/analytics` | GET | Post-exam analytics, gap analysis, study recommendations |
| `/api/v1/recommendations` | GET | Personalized exam and study recommendations |
| `/api/v1/practice-exams` | GET, POST | Topic-based practice exam generation |

---

## Security Architecture

### Authentication

| Property | Value |
|----------|-------|
| Method | JWT with Auth0 |
| Access Token Expiry | 15 minutes |
| Refresh Token Expiry | 7 days |
| MFA | Optional, encouraged for admin users |

### Authorization

| Property | Value |
|----------|-------|
| Model | RBAC (Role-Based Access Control) |
| Roles | student, admin, content_author, psychometrician |
| Enforcement | Middleware + database queries |

### Data Protection

| Aspect | Implementation |
|--------|----------------|
| Encryption in Transit | TLS 1.3 |
| Encryption at Rest | AES-256 |
| PII | Encrypted, access logged |
| Exam Content | Rate-limited API, no bulk export |

### Anti-Harvesting Protection

| Measure | Implementation |
|---------|----------------|
| Rate Limiting | 100 requests/minute per user |
| Anomaly Detection | Pattern matching on rapid question access |
| Exposure Control | Sympson-Hetter method for item selection |

---

## Deployment Architecture

### Infrastructure

| Component | Value |
|-----------|-------|
| Platform | Kubernetes on AWS EKS |
| Containerization | Docker with multi-stage builds |

### Domains

| Domain | Purpose |
|--------|---------|
| `app.uatplatform.com` | Student web application |
| `admin.uatplatform.com` | Platform admin dashboard |
| `api.uatplatform.com` | REST API gateway |

### Scaling

| Property | Value |
|----------|-------|
| Strategy | Horizontal Pod Autoscaler |
| Min Replicas | 2 |
| Max Replicas | 20 |
| Target CPU | 70% |

### CI/CD

| Property | Value |
|----------|-------|
| Platform | GitHub Actions |
| Stages | lint → type-check → test → build → deploy |
| Environments | development, staging, production |

---

## Operational Concerns

### Monitoring

| Aspect | Tool |
|--------|------|
| Metrics | Prometheus + Grafana |
| Logging | Pino → CloudWatch Logs |
| Tracing | OpenTelemetry |
| Alerting | PagerDuty |

### Performance SLAs

| Metric | Target |
|--------|--------|
| Next-Item Latency | P95 < 200ms |
| Concurrent Sessions | 10,000 |
| Uptime | 99.9% |

### Backup Strategy

| Aspect | Implementation |
|--------|----------------|
| Database | Daily snapshots, 30-day retention |
| Point-in-Time Recovery | Enabled for PostgreSQL |
| Cross-Region | Replicated to secondary region |

---

## Architectural Decisions

### ADR-001: Strategy Pattern for Exam Methodologies

| Field | Value |
|-------|-------|
| Decision | Use Strategy design pattern for scoring and item selection algorithms |
| Rationale | Enables adding new exam types without modifying core engine |
| Traceability | REQ-001, REQ-012 |

### ADR-002: PostgreSQL with JSONB for Questions

| Field | Value |
|-------|-------|
| Decision | Store question content in JSONB columns |
| Rationale | Provides schema flexibility while maintaining ACID compliance |
| Traceability | REQ-004, REQ-019 |

### ADR-003: Redis for Session State

| Field | Value |
|-------|-------|
| Decision | Use Redis for active session storage with PostgreSQL backup |
| Rationale | Achieves sub-200ms latency for next-item selection |
| Traceability | REQ-002, REQ-014 |

### ADR-004: Stripe for Payments

| Field | Value |
|-------|-------|
| Decision | Integrate Stripe for all payment processing |
| Rationale | Industry-standard solution with subscription and one-time payment support |
| Traceability | REQ-028, REQ-029 |

### ADR-005: React Native for Mobile

| Field | Value |
|-------|-------|
| Decision | Build mobile app with React Native for iOS and Android |
| Rationale | Code sharing with web, strong TypeScript support, native performance |
| Traceability | REQ-030, REQ-031 |

### ADR-006: Python for Scoring Service

| Field | Value |
|-------|-------|
| Decision | Implement scoring service in Python with FastAPI |
| Rationale | Access to statistical libraries (NumPy, SciPy) for IRT implementations |
| Traceability | REQ-012, REQ-013 |

### ADR-007: MongoDB for Application Settings

| Field | Value |
|-------|-------|
| Decision | Store application settings in MongoDB instead of PostgreSQL |
| Rationale | Enables admin configuration changes without code deployment, flexible schema for evolving settings |
| Traceability | REQ-025, REQ-026 |

### ADR-008: LiteLLM for AI Integration

| Field | Value |
|-------|-------|
| Decision | Use LiteLLM as unified gateway for all LLM providers |
| Rationale | Single API for multiple providers (OpenAI, Anthropic), enables dynamic provider switching via admin settings |
| Traceability | REQ-007 |

### ADR-009: Next.js for Frontend Applications

| Field | Value |
|-------|-------|
| Decision | Build spa-student and spa-admin with Next.js 15 (React) |
| Rationale | Server-side rendering for SEO, React ecosystem, shared component library potential |
| Traceability | REQ-020, REQ-027 |

### ADR-010: Pay-Per-Exam with Unlimited Attempts

| Field | Value |
|-------|-------|
| Decision | Implement pay-per-exam model where each purchase grants unlimited attempts until pass |
| Rationale | Clear value proposition for students, reduces per-attempt anxiety, encourages learning-focused approach |
| Traceability | REQ-029 |

---

## Traceability Matrix

### Requirements to ADR Mapping

| Requirement | ADRs | Components |
|-------------|------|------------|
| REQ-001 | ADR-001 | scoring-service, api-service |
| REQ-002 | ADR-003 | api-service, Redis |
| REQ-003 | - | api-service |
| REQ-004 | ADR-002 | PostgreSQL |
| REQ-005 | - | PostgreSQL (question_tags) |
| REQ-006 | - | PostgreSQL (questions) |
| REQ-007 | ADR-008 | api-service, LiteLLM |
| REQ-008 | - | spa-admin |
| REQ-009 | - | scoring-service, api-service |
| REQ-010 | - | scoring-service |
| REQ-011 | - | api-service |
| REQ-012 | ADR-001, ADR-006 | scoring-service |
| REQ-013 | ADR-006 | scoring-service |
| REQ-014 | ADR-003 | api-service, Redis |
| REQ-015 | - | Kubernetes HPA |
| REQ-016 | - | scoring-service |
| REQ-017 | - | api-service |
| REQ-018 | - | api-service, PostgreSQL |
| REQ-019 | ADR-002 | PostgreSQL |
| REQ-020 | ADR-009 | spa-student |
| REQ-021 | - | spa-student, api-service |
| REQ-022 | - | spa-student, api-service |
| REQ-023 | - | spa-student, api-service |
| REQ-024 | - | spa-student, api-service |
| REQ-025 | ADR-007 | spa-admin, MongoDB |
| REQ-026 | ADR-007 | spa-admin, PostgreSQL |
| REQ-027 | ADR-009 | spa-student |
| REQ-028 | ADR-004 | api-service, Stripe |
| REQ-029 | ADR-004, ADR-010 | api-service, Stripe |
| REQ-030 | ADR-005 | mobile-app |
| REQ-031 | ADR-005 | mobile-app, api-service |

---

## Document History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2026-01-02 | Initial TAD with 6 ADRs |
| 1.0.1 | 2026-01-03 | Added ADR-007 to ADR-010, updated for Next.js, MongoDB, LiteLLM, pay-per-exam model |
